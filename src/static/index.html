<html ng-app="app">
<head>
    <style>
        body {
            font-family: Arial, sans-serif;
        }
        #chat-container {
            width: 500px;
            height: 600px;
            border: 1px solid #ccc;
            padding: 10px;
            overflow-y: auto;
        }
        #chat-log {
            padding: 10px;
        }
        #input-container {
            padding: 10px;
            border-top: 1px solid #ccc;
        }
        #input-field {
            width: 80%;
            height: 30px;
            padding: 10px;
            font-size: 16px;
        }
        #send-btn {
            width: 150px;
            height: 30px;
            background-color: #4CAF50;
            color: #fff;
            border: none;
            cursor: pointer;
            margin: 1px;
        }

        #loginFormContainer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            z-index: 1;
        }

        #loginForm {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            background-color: #f9f9f9;
            z-index: 2;
        }

        #loginForm form {
            max-width: 300px;
            margin: auto;
        }

        #loginForm label {
            margin-bottom: 5px;
        }

        #loginForm input {
            margin-bottom: 15px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }

        #loginForm button[type="submit"] {
            width: 100%;
            padding: 10px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        #loginForm button[type="submit"]:hover {
            background-color: #0069d9;
        }


    </style>
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@stomp/stompjs@7.0.0-beta2/bundles/stomp.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <div id="chat-container">
        <div id="chat-log" style="height: 250px;overflow:scroll;"></div>
        <div id="input-container">
            <input id="myMessage" type="text" placeholder="Type a message...">
            <button id="send-btn" onclick="sendMsg('myMessage')">Send</button><br>

            <input id="_command_auth" type="text" value=">>AUTHtest;password<<">
            <button id="send-btn" onclick="sendMsg('_command_auth')">Auth</button><br>

            <input id="_command_convs" type="text" value=">>CNVS<<">
            <button id="send-btn" onclick="sendMsg('_command_convs')">Load conversations</button><br>

            <input id="_command_load" type="text" value=">>CHAT10;0;100<<">
            <button id="send-btn" onclick="sendMsg('_command_load')">Load conversation</button><br>

            <input id="_comand_send" type="text" value=">>SEND10;SGVsbG8gd29ybGQh<<">
            <button id="send-btn" onclick="sendMsg('_comand_send')">Send message</button><br>

            <input id="_command_create_conv" type="text" value=">>MAKE<<">
            <button id="send-btn" onclick="sendMsg('_command_create_conv')">Create conversation</button><br>

            <input id="_command_exit" type="text" value=">>EXIT<<">
            <button id="send-btn" onclick="sendMsg('_command_exit')">Logout</button><br>

        </div>
    </div>

    <div id="loginFormContainer" style="display: none;">
        <div id="loginForm">
            <div class="mb-3">
                <label for="exampleInputEmail1" class="form-label">Логин</label>
                <input type="text" class="form-control" id="loginFormLogin" aria-describedby="loginHelp" value="test2">
                <!--div id="loginHelp" class="form-text">Введите ваш логин.</div-->
            </div>
            <div class="mb-3">
                <label for="exampleInputPassword1" class="form-label">Пароль</label>
                <input type="password" class="form-control" id="loginFormPasword" value="te-">
            </div>
            <button id="loginFormButton" class="btn btn-primary">Войти</button>
        </div>
    </div>

    <script>
        const chatLog = document.getElementById('chat-log');

        let messages = [];

        // Generate random messages
        function generateRandomMessage() {
            const randomMessages = [
                'Hello, how are you?',
                'What\'s up?',
                'How was your day?',
                'I\'m good, thanks!',
                'What do you want to talk about?'
            ];
            return randomMessages[Math.floor(Math.random() * randomMessages.length)];
        }

        // Add message to chat log
        function addMessage(message, isUser) {
            const messageHTML = document.createElement('div');
            messageHTML.textContent = message;
            if (isUser) {
                messageHTML.style.textAlign = 'right';
            }
            chatLog.appendChild(messageHTML);
            chatLog.scrollTop = chatLog.scrollHeight;
        }

        // Send message
/*
        sendBtn.addEventListener('click', () => {
            const userMessage = inputField.value.trim();
            if (userMessage) {
                addMessage(userMessage, true);
                inputField.value = '';
                // Generate random response
                const randomResponse = generateRandomMessage();
                setTimeout(() => {
                    addMessage(randomResponse, false);
                }, 1000);
            }
        });*/

        // Start chat with random message
        addMessage(generateRandomMessage(), false);

    </script>

    <script>


        const client = new StompJs.Client({
          brokerURL: 'ws://127.0.0.1:8080/ws',
          connectHeaders: {},
          debug: function (str) 
            {
            console.log(str);
          },
          reconnectDelay: 5000,
          heartbeatIncoming: 4000,
          heartbeatOutgoing: 4000,
        });

        //addMessage(clientId, false);
        function toast(clz, message)
        {
            Toastify({
              text: message,
              className: clz,
            }).showToast();
        }

        function request(path, bodySrc, onOk, onError)
        {
            var body = Object.assign({}, bodySrc);
            var request_id = parseInt(Math.random()*100000000000) + '';
            // request_id отправляется в body для получения в body-ответа, и в headers, для обработчика в спринге(мне лень мучаться с пробросом BaseRequest в GlobalExceptionHandler)
            body['request_id'] = request_id;

            if (!client.__requests)
                client.__requests = {};

            if (!client.__registeredPaths)
                client.__registeredPaths = {};

            if (!client.__hasErrorHandler)
                client.__hasErrorHandler = 'no';

            client.__requests[request_id] = [onOk, onError];

            var fullPath = '/app' + path;
            if (!(fullPath in client.__registeredPaths))
            {
                client.subscribe('/user' + path, (frame) => 
                {
                    var bodyParsed = undefined;
                    try
                    {
                        bodyParsed = JSON.parse(frame.body);
                    } catch (e) 
                    {
                        toast('fail', 'Unknown data received at data handler for path=' + path);
                        return;
                    }

                    if (!bodyParsed.request_id)
                    {
                        toast('fail', 'Received data with unknown request id for path=' + path);
                        return;
                    }
                    client.__requests[bodyParsed.request_id][0](bodyParsed);
                });

                client.__registeredPaths[fullPath] = 'yes';
            }

            if (client.__hasErrorHandler == 'no')
            {
                client.subscribe('/user/error', (frame) =>
                {
                    var bodyParsed = undefined;
                    try
                    {
                        bodyParsed = JSON.parse(frame.body);
                    } catch (e) 
                    {
                        toast('fail', 'Unknown data received at error handler');
                        return;
                    }

                    if (!bodyParsed.request_id)
                    {
                        toast('fail', 'Received error with unknown request id');
                        return;
                    }

                    client.__requests[bodyParsed.request_id][1](bodyParsed);
                });
                client.__hasErrorHandler = 'yes';
            }

            client.publish({destination: fullPath, headers: {'request_id': request_id}, body: JSON.stringify(body)}); 
        }

        function processEvent(type, args)
        {
            switch (type)
            {
                case 'connected':
                {
                    var token = localStorage.getItem('token');
                    if (token)
                    {
                        console.log('has token'+token+', try back in');
                        request('/uctl/back', {'token': token}, 
                            (response) => 
                            {
                                pushEvent('logged');
                            }, 
                            (error) =>
                            {
                                pushEvent('login_by_token_failed');
                            });
                    }
                    else
                    {
                        console.log('no token, display auth form...');
                        pushEvent('login_required');
                    }
                } break;
                case 'login':
                {
                    request('/uctl/login', args, 
                        (response) => 
                        {
                            localStorage.setItem('token', response.token);
                            pushEvent('logged');
                        }, 
                        (error) =>
                        {
                            pushEvent('login_by_credentials_failed');
                        });
                }
                break;
                case 'logged':
                {
                    // request conversations...
                    toast('ok', 'Вход выполнен');
                    $('#loginFormContainer').hide();
                }
                break;
                case 'login_by_token_failed':
                {
                    localStorage.removeItem('token');
                    toast('fail', 'Токен устарел');
                }
                case 'login_required':
                {
                    // display login form here
                    $('#loginFormContainer').fadeIn();

                } break;
                case 'login_by_credentials_failed':
                {
                    toast('fail', 'Неверный логин и/или пароль');
                } break;


            }

        }

        function pushEvent(type, args)
        {
            processEvent(type, args);
        }

        $(document).ready(function() {
            $('#loginFormButton').click(function() {
                pushEvent('login', {'login': $('#loginFormLogin').val(), 'password': $('#loginFormPasword').val()});
            });
        });

        client.onConnect = function (frame) {
            pushEvent('connected');
/*

            console.log(client);

            client.subscribe('/user/error', (frame) =>
            {
                var message = '???';
                try
                {
                    message = JSON.parse(frame.body).message;
                } catch (e) 
                {
                    ;
                }
                toast('fail', 'Service response error: ' + message);
            });

            client.subscribe('/user/uctl/login', (frame) => 
            {
            
                var token = undefined;
                try
                {
                    token = JSON.parse(frame.body).token;
                } catch (e) 
                {
                    ;
                }

                localStorage.setItem('token', token);
                if (!token)
                {
                    toast('fail', 'Unknown auth error');
                    return;
                }

                
                toast('debug', 'Authed');
            });

            {          
                var token = localStorage.getItem('token');
                if (token)
                {
                    client.publish({destination: '/app/uctl/back', body: JSON.stringify({'token': token})}); 
                }
                else
                {
                    client.publish({destination: '/app/uctl/login', body: JSON.stringify({'login': 'test2', 'password': 'te-'})}); 
                }
                // client.publish({destination: '/app/register', body: JSON.stringify({'login': 'test2', 'password': 'te-'})}); 
            }
*/
        };

        client.onStompError = function (frame) 
        {
          console.log('Broker reported error: ' + frame.headers['message']);
          console.log('Additional details: ' + frame.body);
        };

        client.activate();

    </script>
</body>
</html>
