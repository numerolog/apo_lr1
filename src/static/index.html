<html ng-app="app">
<head>
    <style>
        body {
            font-family: Arial, sans-serif;
        }
        #chat-container {
            width: 500px;
            height: 600px;
            border: 1px solid #ccc;
            padding: 10px;
            overflow-y: auto;
        }
        #chat-log {
            padding: 10px;
        }
        #input-container {
            padding: 10px;
            border-top: 1px solid #ccc;
        }
        #input-field {
            width: 80%;
            height: 30px;
            padding: 10px;
            font-size: 16px;
        }
        #send-btn {
            width: 15%;
            height: 30px;
            background-color: #4CAF50;
            color: #fff;
            border: none;
            cursor: pointer;
        }
    </style>

    <script type="text/javascript">

    var myWebSocket;

    const WSB_MESSAGE_MAGIC = 0x5742;
    const WSB_SCOPE_OPTIONS = 1;
    const WSB_TYPE_OPTIONS_DONTSENDBROADCASTS = 1;
    const WSB_SCOPE_RESPONSE = 127;

    const WSB_SCOPE_TELEMETRY = 2;
    const WSB_TELEMETRY_TEMP = 1;
    const WSB_TELEMETRY_CPUS = 2;
    const WSB_TELEMETRY_RAMS = 3;

    const WSB_SCOPE_CAMERA_0 = 3;
    const WSB_CAM0_STREAMCHUNK = 1;
    const WSB_CAM0_OBJECT = 3;

    // Функция для парсинга текста
    async function parsePacket(data) {
        //const bb = await data.bytes();
        var bb = await data.arrayBuffer();
        // Протокол отправляется в LE (надо везде видимо писать true)
        //const dataView = new DataView(bb.buffer, bb.byteOffset, bb.byteLength);
        const dataView = new DataView(bb);
        const magic = dataView.getUint16(0, true);
        if (magic !== WSB_MESSAGE_MAGIC)
        {
            console.error('bad magic, expected: ' + WSB_MESSAGE_MAGIC + ', received: ' + magic);
            return;
        }
        //const uint8array = Uint8Array.from(text, c=>c.charCodeAt(0));
        // console.log(dataView);
        const scope = dataView.getUint8(2);
        const type  = dataView.getUint8(3);
       // console.log('received packet scope=' + scope + ', type=' + type);
        if (scope === WSB_SCOPE_TELEMETRY)
        {
            switch (type)
            {
                case WSB_TELEMETRY_TEMP:
                    parseTemp(dataView.getFloat32(4, true));
                break;
                case WSB_TELEMETRY_CPUS:
                    parseCpu(dataView.getFloat32(4, true));
                break;
                case WSB_TELEMETRY_RAMS:
                    parseRam(dataView.getFloat32(4, true));
                break;
            }
        }
        else if (scope === WSB_SCOPE_CAMERA_0)
        {
            switch (type)
            {
                case WSB_CAM0_STREAMCHUNK:
                    parseCam0StreamChunk(new Uint8Array(bb).slice(4));//.slice(3, -1));
                break;
                case WSB_CAM0_OBJECT:
                    parseCam0Object(dataView.getInt32(4*1, true), dataView.getInt32(4*2, true), dataView.getInt32(4*3, true), dataView.getInt32(4*4, true), dataView.getInt32(4*5, true), dataView.getInt32(4*6, true), dataView.getInt32(4*7, true), dataView.getInt32(4*8, true));
                break;
            }
        }


        /*
        const startDelimiter = '>>';
        const endDelimiter = '<<';
        let startIndex = 0;

        while (true) {
            // Находим индекс начала следующего совпадения
            startIndex = text.indexOf(startDelimiter, startIndex);
            if (startIndex === -1) break; // Если не найдено, выходим из цикла

            // Находим индекс конца совпадения
            const endIndex = text.indexOf(endDelimiter, startIndex);
            if (endIndex === -1) break; // Если не найдено, выходим из цикла

            // Извлекаем строку между разделителями
            var data = text.substring(startIndex, endIndex + endDelimiter.length);
        
            
            // Проверяем, соответствует ли строка формату >>TYPExxxxxx<<
            const type = data.substring(2, 6); // Получаем TYPE (4 символа)
            data = data.substring(startIndex+startDelimiter.length+4, endIndex);

            if (type === 'TEMP')
                parseTemp(data);
            if (type === 'CPUS')
                parseCpu(data);

            
            // Обновляем индекс для поиска следующего совпадения
            startIndex = endIndex + endDelimiter.length;
        }*/
    }


    function connectToWS() {
        console.log("try to connect... ");
        if (myWebSocket !== undefined) 
        {
            myWebSocket.close()
        }

        myWebSocket = new WebSocket('ws://127.0.0.1:8080/ws');
        var timeout = setTimeout(()=>{
            if (myWebSocket !== undefined)
                myWebSocket.close();
            myWebSocket = undefined;
        }, 3000);
        myWebSocket.onmessage = function(event) {
            var text = event.data.toString();
            const startDelimiter = '>>';
            const endDelimiter = '<<';
            let startIndex = 0;

            while (true) {
                // Находим индекс начала следующего совпадения
                startIndex = text.indexOf(startDelimiter, startIndex);
                if (startIndex === -1) break; // Если не найдено, выходим из цикла

                // Находим индекс конца совпадения
                const endIndex = text.indexOf(endDelimiter, startIndex);
                if (endIndex === -1) break; // Если не найдено, выходим из цикла

                // Извлекаем строку между разделителями
                var data = text.substring(startIndex, endIndex + endDelimiter.length);
            
                
                // Проверяем, соответствует ли строка формату >>TYPExxxxxx<<
                const type = data.substring(2, 6); // Получаем TYPE (4 символа)
                data = data.substring(startIndex+startDelimiter.length+4, endIndex);
                
                addMessage(data, false);
                console.log(data);
                
                // Обновляем индекс для поиска следующего совпадения
                startIndex = endIndex + endDelimiter.length;
            }
        }

        myWebSocket.onopen = function(evt) {
            console.log("onopen.");
            clearTimeout(timeout);
        };

        myWebSocket.onclose = function(evt) {
            console.log("onclose.");
            myWebSocket = undefined;
            setTimeout(function() {
              connectToWS();
            }, 3000);
        };

        myWebSocket.onerror = function(evt) {
            console.log("Error!");/*
            setTimeout(function() {
              connectToWS();
            }, 3000);*/
        };
    }

    function sendMsg(elementId) {
        var message = document.getElementById(elementId).value;
        console.log('send ' + message);
        myWebSocket.send(message);
        addMessage(message, true);

    }


/*
    function closeConn() {
        myWebSocket.close();
    }*/
// awk '/\/.*\// {print $NF}' /proc/254/maps | sort -u | xargs -r du -h
    </script>
</head>
<body>

    

    <!--input type="button" onclick="connectToWS()" value="connect to WebSocket endpoint" /><br><br>
    <input type="button" onclick="closeConn()" value="Close connection" /-->

    <div id="chat-container">
        <div id="chat-log" style="height: 250px;overflow:scroll;"></div>
        <div id="input-container">
            <input id="myMessage" type="text" placeholder="Type a message...">
            <button id="send-btn" onclick="sendMsg('myMessage')">Send</button><br>

            <input id="_command_auth" type="text" value=">>AUTHtest;password<<">
            <button id="send-btn" onclick="sendMsg('_command_auth')">Auth</button><br>

            <input id="_command_convs" type="text" value=">>CNVS<<">
            <button id="send-btn" onclick="sendMsg('_command_convs')">Load conversations</button><br>

            <input id="_command_create_conv" type="text" value=">>MAKE<<">
            <button id="send-btn" onclick="sendMsg('_command_create_conv')">Create conversation</button><br>

            <input id="_command_exit" type="text" value=">>EXIT<<">
            <button id="send-btn" onclick="sendMsg('_command_exit')">Logout</button><br>

        </div>
    </div>

    <script>
        const chatLog = document.getElementById('chat-log');

        let messages = [];

        // Generate random messages
        function generateRandomMessage() {
            const randomMessages = [
                'Hello, how are you?',
                'What\'s up?',
                'How was your day?',
                'I\'m good, thanks!',
                'What do you want to talk about?'
            ];
            return randomMessages[Math.floor(Math.random() * randomMessages.length)];
        }

        // Add message to chat log
        function addMessage(message, isUser) {
            const messageHTML = document.createElement('div');
            messageHTML.textContent = message;
            if (isUser) {
                messageHTML.style.textAlign = 'right';
            }
            chatLog.appendChild(messageHTML);
            chatLog.scrollTop = chatLog.scrollHeight;
        }

        // Send message
/*
        sendBtn.addEventListener('click', () => {
            const userMessage = inputField.value.trim();
            if (userMessage) {
                addMessage(userMessage, true);
                inputField.value = '';
                // Generate random response
                const randomResponse = generateRandomMessage();
                setTimeout(() => {
                    addMessage(randomResponse, false);
                }, 1000);
            }
        });*/

        // Start chat with random message
        addMessage(generateRandomMessage(), false);

    </script>

    <script>

        connectToWS();
    </script>
</body>
</html>
